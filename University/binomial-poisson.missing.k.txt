# Ας υποθέσουμε ότι τα δεδομένα μας είναι
# 3/5, 2/5, 1/4, 5/6, 2/7, 2/?, 1/?, 0/?, 3/?, 2/?

m=5; n=10

x = c(3,2,1,5,2,2,1,0,3,2); # n=length(x)
k.obs = c(5,5,4,6,7); # m=length(k.obs)

# Εκ των προτέρων κατανομές 
# p~Beta(a,b), λ~G(g,d), ανεξάρτητα

# Παράμετροι εκ των προτέρων κατανομής:

a=b=0.5 	# Η εκ των προτέρων του p είναι η Jeffreys
g=0.5;d=0.1 	# Επειδή η "μαντεψιά" μας για το λ 
		# είναι 5 (=g/d) αλλά δεν θέλουμε 
		# να δηλώσουμε μεγάλη βεβαιότητα σε αυτήν 
		# την τιμή: Var(λ)=g/d^2=50. 

Sx = sum(x)	# Χρειάζεται το Σx[i] παρακάτω


# Εδώ θα αποθηκεύσουμε τις τιμές που θα προσομοιώσουμε:

p.sim = c()
lam.sim = c() # Γράφω lam αντί για λ
k.sim = c()

# Επειδή θα γεννάμε εναλλάξ (p,λ) και (k[m+1],...,k[n])
# χρειαζόμαστε "αρχικές τιμές" μόνο για τα k
# Θα μας βολέψει να έχουμε ως k ολόκληρο το n-διάστατο διάνυσμα
# δηλαδή και με τα παρατηρηθέντα και με τα μη παρατηρηθέντα k[i]. 
# Φυσικά, θα γεννάμε τιμές μόνο για τα μη παρατηρηθέντα.
# Μία λογική επιλογή για αρχή είναι k[i]=x[i], i=m+1,...,n
# (όχι πως έχει σημασία, ό,τι κι αν βάλουμε στο ίδιο θα καταλήγαμε).

k = c(k.obs,x[(m+1):n])

for ( i in 1:11000 ){

	# Πρώτα (p,λ) από την δεσμευμένη εκ των υστέρων τους
	# δοθέντος k[m+1],...,k[n]	

	p = rbeta(1,a+Sx,b+sum(k)-Sx) 
	lam = rgamma(1,g+sum(k),d+n)

	# Μετά k[m+1],...,k[n] από την δεσμευμένη εκ των 
	# υστέρων τους δοθέντος p,λ (που το λέω lam)
	# Όπως είπαμε, k[i]|p,λ ~ την ίδια κατανομή με 
	# το Y[i]+x[i], όπου Y[i]~P((1-p)*λ) οπότε το καινούργιο
	# k είναι (στις πρώτες m θέσεις αφήνω το k.obs όπως πριν) 

	k = c(k.obs, rpois(n-m,(1-p)*lam)+x[(m+1):n])

	# Εδώ αποθηκεύω τις τιμές που γεννήθηκαν: Το p και το λ στα

	p.sim = c(p.sim,p)
	lam.sim = c(lam.sim,lam)

	# ενώ το k (που είναι ένα διάνυσμα)

	k.sim = rbind(k.sim,k)

	# Η συνάρτηση rbind προσθέτει γραμμές στο τέλος ενός πίνακα.
	# Ο k.sim είναι ένας πίνακας που η διάστασή του αυξάνεται
	# κατά μία γραμμή σε κάθε επανάληψη. Παρεμπιπτόντως, η αντίστοιχη
	# συνάρτηση για να προσθέσουμε στήλες είναι η cbind  

	}


# Τις πρώτες 1000 προσομοιωμένες τιμές θα τις "κάψω". 

# Ιστόγραμμα εκ των υστέρων κατανομής του p:

hist(p.sim[1001:11000],freq=F)

# Προσεγγίσεις της υστέρων μέσης τιμής και διαμέσου του p:

mean(p.sim[1001:11000])
median(p.sim[1001:11000])

# Η σύγκλιση της ακολουθίας των μέσων με μία εικόνα:

plot(cumsum(p.sim[1001:11000])/(1:10000),type='l')

# Σε περίπτωση που δούμε ότι η ακολουθία δεν έχει σταθεροποιηθεί
# ενδεχομένως να χρειάζεται να ξανακάνουμε την προσομοίωση
# με μεγαλύτερο μήκος αλυσίδας από 10000. 

# Τα ίδια για το λ:

hist(lam.sim[1001:11000],freq=F)
mean(lam.sim[1001:11000])
median(lam.sim[1001:11000])
plot(cumsum(lam.sim[1001:11000])/(1:10000),type='l')

# Ο k.sim είναι ένας πίνακας διαστάσεων

dim(k.sim)

# (Πρέπει να βλέπετε ότι έχει 11000 γραμμές και 10 στήλες.)
# Επειδή θα "κάψουμε" τα πρώτα 1000 k, θα δουλέψουμε με τον
# k.sim[1001:11000,] : Για να πάρουμε έναν υποπίνακα ενός
# πίνακα, δηλώνουμε τους αύξοντες αριθμούς των γραμμών που 
# θέλουμε (που εδώ είναι από την 1001 έως την 11000) και τους
# αύξοντες αριθμούς των στηλών. Αν θέλουμε είτε όλες τις γραμμές
# είτε όλες τις στήλες δεν γράφουμε τίποτα. (Μετά το κόμμα δεν
# έχω βάλει τίποτα δηλώνοντας έτσι ότι θέλω όλες τις στήλες. Αν
# ήθελα να πάρω όλες τις γραμμές και τις στήλες 2,5,3,8 θα έγραφα
# k.sim[,c(2,5,3,8)].)

# Σημειώστε ότι οι m=5 πρώτες στήλες του k.sim έχουν συνέχεια
# 5,5,4,6,7 γιατί σε κάθε γραμμή του βάζαμε εκεί το k.obs

# Για να πάρουμε την εκ των υστέρων κατανομή του k[6]:

table(k.sim[1001:11000,6])/10000

# Φυσικά αυτή είναι μία προσέγγισή της μια και η εκ των υστέρων
# πιθανότητα το k[6] να πάρει οποιαδήποτε ακέραια τιμή από x[6]
# και πάνω είναι θετική.
# Ιστόγραμμα της (προσέγγισης) της εκ των υστέρων κατανομής του k[6]:

plot(table(k.sim[1001:11000,6])/10000,type='h')

# Προσεγγίσεις των εκ των υστέρων μέσων τιμών όλων των k[i]:

colMeans(k.sim[1001:11000])

# (Η συνάρτηση colMeans δίνει τους αριθμητικούς μέσους των στηλών
#  ενός πίνακα. Η αντίστοιχη συνάρτηση για τους μέσους των γραμμών
#  είναι η rowMeans αλλά δεν μας ενδιαφέρει εδώ.)
# Φυσικά, οι μέσοι για τα πρώτα m k[i] είναι 5,5,4,6,7. Οι υπόλοιποι
# είναι που ενδιαφέρουν εμάς.












