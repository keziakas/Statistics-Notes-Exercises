# Ας υποθέσουμε ότι τα δεδομένα μας είναι τυχαίο δείγμα
# μεγέθους 20 από κανονική κατανομή

n = 20
x = rnorm(n,mean=20,sd=2)

# Εδώ γεννάω 20 παρατηρήσεις από κανονική με μέση τιμή 
# μ=20 και τυπική απόκλιση σ=2. Θα προσποιηθούμε ότι αυτά
# είναι τα δεδομένα μας. Φυσικά, όταν έχουμε πραγματικά δεδομένα
# δεν ξέρουμε από ποια κατανομή προήλθαν.

# Η εκ των προτέρων κατανομή των μ, σ^2 υποτίθεται ότι είναι
# π(μ,σ^2) = π(μ)π(σ^2)
# με μ~Ν(μ0,τ^2), σ^2~IG(α/2,β/2)
# Ας υποθέσουμε ότι επιλέξαμε τις ακόλουθες τιμές για παραμέτρους
# της εκ των προτέρων κατανομής:

mu0 = 25; tau2 = 100; 
a = 1; b = 0.1

# (Γράφω mu0 αντί για μ0, tau2 αντί για τ^2, a αντί για α, b αντί για β. 
#  Η R δεν καταλαβαίνει Ελληνικά.)

# Εδώ είναι ο μέσος και η διασπορά των παρατηρήσεων (οι τιμές του 
# δειγματικού μέσου και της δειγματικής διασποράς).

xbar = mean(x)
sigma2 = var(x)

# Ο δειγματολήπτης Gibbs προσομοιώνει εναλλάξ από τις πλήρεις δεσμευμένες
# (εκ των υστέρων) κατανομές των μ και σ^2 που είναι
# μ|σ^2,x ~ N( (n*τ^2*xbar+σ^2*μ0)/(n*τ^2+σ^2), σ^2*τ^2/(n*τ^2+σ^2) )
# σ^2|μ,x ~ IG( (α+n)/2, (β+Σ(xi-μ)^2)/2 )

# Ετοιμάζω δύο κενές λίστες που θα τις γεμίσω με τις προσομοιωμένες τιμές:

mu.sim = c()
sigma2.sim = c()

# Θα προσομοιώσω 11000 τιμές (τις 1000 πρώτες μέτα θα τις "κάψω" 
# ως περίοδο burn-in.


for ( i in 1:11000 ){

	mu = rnorm(1,
		mean=(n*tau2*xbar+sigma2*mu0)/(n*tau2+sigma2),
		sd=sqrt(tau2*sigma2/(n*tau2+sigma2)))
	sigma2 = 1/rgamma(1,shape=(a+n)/2,rate=(b+sum((x-mu)^2))/2)

	mu.sim = c(mu.sim,mu)
	sigma2.sim = c(sigma2.sim,sigma2)

	}

# Στην πρώτη επανάληψη, γεννάω mu (δηλαδή μ) από την δεσμευμένη κατανομή του
# δοθέντος σ^2=sigma2 που έχει τεθεί παραπάνω ίσο με την διασπορά των 
# παρατηρηθεισών τιμών. Μετά προσομοιώνω μία γάμμα με παράμετρο σχήματος
# (a+n)/2 και ρυθμού (b+sum((x-mu)^2))/2 (το mu είναι αυτό που έχει γεννηθεί 
# στο προηγούμενο βήμα) και θέτω το sigma2 ίσο με το αντίστροφό της. (Η αντίστροφη
# γάμμα είναι η κατανομή που έχει η 1/Υ όταν η Υ ακολουθεί γάμμα.) Να πω εδώ
# ότι sum((x-mu)^2) είναι το Σ(xi-mu)^2: το x-mu είναι το διάνυσμα που έχει στην
# i θέση το x[i]-mu, i=1,...,n, το (x-mu)^2 είναι το διάνυσμα που έχει στην
# i θέση το (x[i]-mu)^2, i=1,...,n, και το sum((x-mu)^2) είναι το άθροισμα των 
# εισόδων (στοιχείων) του διανύσματος (x-mu)^2. Άρα το sigma2 έχει γεννηθεί 
# από την δεσμευμένη κατανομή του σ^2 δοθέντος μ=mu. Στη συνέχεια, την τιμή mu
# την βάζω στο τέλος της λίστας mu.sim (που ήταν άδεια άρα τώρα έχει μόνο αυτήν
# την τιμή), και την τιμή sigma2 στο τέλος της λίστας sigma2.sim (που και αυτή
# πριν ήταν άδεια). Το R πάει τώρα για την δεύτερη επανάληψη.
# Στην δεύτερη επανάληψη γεννάω mu από την δεσμευμένη κατανομή του δοθέντος
# σ^2=sigma2, με το sigma2 τώρα να είναι η τελευταία προσομοιωμένη τιμή του σ^2. 
# Μετά γεννάω από την δεσμευμένη κατνανομή του σ^2 δοθέντος μ=mu όπου mu τώρα
# είναι η αμέσως προηγούμενη τιμή. Η κάθε προσομοιωμένη τιμή πάει στο τέλος της 
# αντίστοιχης λίστας και συνεχίζουμε για την τρίτη επανάληψη. Η διαδικασία 
# συνεχίζεται μέχρι οι δύο λίστες να έχουν μήκος 11000.

# Στη συνέχεια καίμε τις πρώτες 1000 εισόδους της κάθε λίστας:

mu.sim.1 = mu.sim[1001:11000] # η νέα λίστα περιέχει τις εισόδους της παλιάς
			      # από τη θέση 1001 έως την 11000
sigma2.sim.1 = sigma2.sim[1001:11000]

# Ιστογράμματα που εκτιμούν τις εκ των υστέρων κατανομές των μ,σ^2:
# (δώστε τις εντολές μία μία)

hist(mu.sim.1,freq=F) # για το μ; το freq=F κάνει το ιστόγραμμα να έχει 
		      # συνολικό εμβαδόν ίσο με τη μονάδα

hist(sigma2.sim.1,freq=F)

# Εκτιμήσεις των εκ των υστέρων μέσων τιμών των μ,σ^2:

mean(mu.sim.1)
mean(sigma2.sim.1)

# και των αντίστοιχων εκ των υστέρων διαμέσων:

median(mu.sim.1)
median(sigma2.sim.1)

# Το ίδιο παίρνουμε και με την εντολή quantile:

quantile(mu.sim.1,0.5)
quantile(sigma2.sim.1,0.5)

# Αν θέλετε να δείτε την σύγκλιση των εργοδικών μέσων (δηλαδή των ακολουθιών
# των δειγματικών μέσων) γράψτε (ένα ένα)

plot( cumsum(mu.sim.1)/(1:length(mu.sim.1)), type='l' ) 
# type='l' (αγγλικό ελ) για να ενώσει τα σημεία με γραμμή (line)

plot( cumsum(sigma2.sim.1)/(1:length(sigma2.sim.1)), type='l' )

# cumsum(ενός διανύσματος) δίνει την ακολουθία των μερικών αθροισμάτων, π.χ.
# cumsum(c(x1,x2,x3,x4,x5)) = c(x1,x1+x2,x1+x2+x3,x1+x2+x3+x4,x1+x2+x3+x4+x5)
# Επίσης, 1:κάποιον αριθμό είναι η ακολουθία 1,2,...,αυτός ο αριθμός, π.χ.
# 1:5 = c(1,2,3,4,5). Όταν "διαιρούμε" στην R διανύσματα ίδιου μήκους τότε  
# το αποτέλεσμα είναι το διάνυσμα με i είσοδο τον λόγο των i εισόδων. Οπότε
# cumsum(c(x1,x2,x3,x4,x5))/(1:length(c(x1,x2,x3,x4,x5))) (το length είναι 5)
# δίνει c(x1,(x1+x2)/2,(x1+x2+x3)/3,(x1+x2+x3+x4)/4,(x1+x2+x3+x4+x5)/5)
# !!! Όταν σχεδιάζουμε τέτοια ακολουθία βλέπουμε ότι έχουμε σύγκλιση όταν
# πλέον καταλήγει σαν (σχεδόν) ευθεία γραμμή. Αν ακόμη "παίζει" και δεν έχει 
# σταθεροποιηθεί τότε χρειάζεται να γεννήσουμε κι άλλες τιμές. Ξανατρέχουμε 
# την προσομοίωση με περισσότερες επαναλήψεις (που εδώ τις έχουμε 11000). 

# 95% αξιόπιστα διαστήματα για τα μ και σ^2:

c(quantile(mu.sim.1,.025),quantile(mu.sim.1,.975))
c(quantile(sigma2.sim.1,.025),quantile(sigma2.sim.1,.975))

# Μπορούμε να εκτιμήσουμε και συναρτήσεις των μ,σ^2. Π.χ.:

# Ιστόγραμμα της εκ των υστέρων του μ/σ:

hist(mu.sim.1/sqrt(sigma2.sim.1),freq=F)

# Εκ των υστέρων μέση τιμή του μ^2/σ^2:

mean(mu.sim.1^2/sigma2.sim.1)

# Εκ των υστέρων διάμεσος του συντελεστή μεταβλητότητας σ/μ

median(sqrt(sigma2.sim.1)/mu.sim.1)

# Εκ των υστέρων συντελεστής συσχέτισης των μ,σ^2:

cor(mu.sim.1,sigma2.sim.1) # cor από το correlation



 





